<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Negotiation - GrowToCourt</title>
    <style>
        :root {
            --primary-black: #000000;
            --white: #ffffff;
            --clifford-blue: #0066cc;
            --clifford-teal: #4a9b9b;
            --clifford-purple: #8b5a96;
            --clifford-orange: #e67e22;
            --light-blue: #e8f4fd;
            --light-grey: #f8f9fa;
            --medium-grey: #6c757d;
            --accent-grey: #495057;
            --success-green: #28a745;
            --warning-orange: #fd7e14;
            --danger-red: #dc3545;
            --info-blue: #17a2b8;
            --highlight-yellow: #fff3cd;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--primary-black);
            background-color: var(--white);
        }

        .container {
            max-width: 1700px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        header {
            background: var(--primary-black);
            color: var(--white);
            padding: 1.5rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 20px rgba(0,0,0,0.15);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 300;
            text-decoration: none;
            color: var(--white);
            letter-spacing: -0.5px;
        }

        .step-indicator {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1rem;
            opacity: 0.9;
        }

        /* Header Training Progress */
        .header-training-progress {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .header-steps {
            display: flex;
            gap: 0.5rem;
        }

        .header-step {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.6);
        }

        .header-step.current {
            border-color: var(--white);
            background: var(--white);
            color: var(--primary-black);
        }

        .header-step.completed {
            border-color: var(--clifford-teal);
            color: var(--clifford-teal);
        }

        .header-progress-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        .nav-buttons {
            display: flex;
            gap: 1rem;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.15);
            color: var(--white);
            padding: 0.6rem 1.2rem;
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-weight: 500;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }

        /* Main Layout */
        .main-content {
            padding: 2rem 0;
            min-height: calc(100vh - 80px);
        }

        .intro-section {
            text-align: center;
            margin-bottom: 3rem;
        }

        .intro-section h2 {
            font-size: 2.5rem;
            font-weight: 300;
            color: var(--primary-black);
            margin-bottom: 1rem;
            letter-spacing: -1px;
        }

        .intro-section p {
            font-size: 1.2rem;
            color: var(--medium-grey);
            max-width: 900px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3rem;
            margin-top: 2rem;
        }

        /* Left Side - Negotiation Chat */
        .negotiation-panel {
            background: var(--white);
            border-radius: 12px;
            padding: 2.5rem;
            box-shadow: 0 4px 30px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
            height: fit-content;
        }

        .negotiation-profile {
            background: linear-gradient(135deg, #e8f4fd, #f0f8ff);
            border: 1px solid var(--clifford-teal);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--clifford-blue), var(--clifford-teal));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 600;
            font-size: 1.2rem;
        }

        .profile-info h3 {
            color: var(--primary-black);
            font-size: 1.2rem;
            margin-bottom: 0.25rem;
        }

        .profile-info p {
            color: var(--medium-grey);
            font-size: 0.9rem;
        }

        .scenario-summary {
            background: var(--light-grey);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .scenario-summary h4 {
            color: var(--primary-black);
            font-size: 0.95rem;
            margin-bottom: 0.5rem;
        }

        .scenario-summary p {
            color: var(--medium-grey);
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .chat-container {
            background: var(--light-grey);
            border-radius: 12px;
            height: 400px;
            overflow-y: auto;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 2px solid #e5e7eb;
        }

        .message {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: flex-start;
        }

        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        .message.counterparty .message-avatar {
            background: linear-gradient(135deg, var(--clifford-purple), var(--clifford-orange));
            color: var(--white);
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, var(--clifford-teal), var(--clifford-blue));
            color: var(--white);
        }

        .message-content {
            flex: 1;
        }

        .message-sender {
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
            color: var(--accent-grey);
        }

        .message-text {
            background: var(--white);
            padding: 1rem;
            border-radius: 8px;
            line-height: 1.5;
            font-size: 0.9rem;
            border: 1px solid #e5e7eb;
        }

        .message.user .message-text {
            background: linear-gradient(135deg, #e8f4fd, #f0f8ff);
            border-color: var(--clifford-teal);
        }

        .input-section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .input-controls {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }

        .text-input {
            flex: 1;
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
            transition: border-color 0.3s ease;
        }

        .text-input:focus {
            outline: none;
            border-color: var(--clifford-teal);
            box-shadow: 0 0 0 3px rgba(74, 155, 155, 0.1);
        }

        .send-btn {
            background: linear-gradient(135deg, var(--clifford-teal), var(--primary-black));
            color: var(--white);
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            margin-top: 1rem;
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(74, 155, 155, 0.4);
        }

        /* Right Side - Mentor AI */
        .mentor-panel {
            background: var(--white);
            border-radius: 12px;
            padding: 2.5rem;
            box-shadow: 0 4px 30px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
            height: fit-content;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--light-grey);
        }

        .section-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary-black);
            color: var(--white);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
        }

        .section-icon svg {
            width: 24px;
            height: 24px;
            stroke: var(--white);
            stroke-width: 2;
        }

        .section-header h3 {
            color: var(--primary-black);
            font-size: 1.4rem;
            font-weight: 600;
            margin: 0;
        }

        .mentor-chat {
            background: var(--light-grey);
            border-radius: 12px;
            height: 400px;
            overflow-y: auto;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 2px solid #e5e7eb;
        }

        .mentor-input-section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .mentor-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.9rem;
            font-family: inherit;
            resize: vertical;
            min-height: 50px;
            transition: border-color 0.3s ease;
        }

        .mentor-input:focus {
            outline: none;
            border-color: var(--clifford-teal);
            box-shadow: 0 0 0 3px rgba(74, 155, 155, 0.1);
        }

        .mentor-btn {
            background: linear-gradient(135deg, var(--clifford-blue), var(--clifford-purple));
            color: var(--white);
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .mentor-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 90, 150, 0.4);
        }

        .progress-section {
            background: linear-gradient(135deg, #e8f4fd, #f0f8ff);
            border: 1px solid var(--clifford-teal);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .progress-title {
            color: var(--primary-black);
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .progress-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--clifford-teal);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--medium-grey);
        }

        .performance-meter {
            background: var(--light-grey);
            border-radius: 12px;
            height: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .meter-fill {
            background: linear-gradient(90deg, var(--clifford-teal), var(--clifford-blue));
            height: 100%;
            border-radius: 12px;
            transition: width 0.5s ease;
            width: 0%;
        }

        .proceed-button {
            background: linear-gradient(135deg, var(--clifford-teal), var(--primary-black));
            color: var(--white);
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            width: 100%;
            margin-top: 1.5rem;
            transition: all 0.3s ease;
            opacity: 0.5;
            cursor: not-allowed;
        }

        .proceed-button.enabled {
            opacity: 1;
            cursor: pointer;
        }

        .proceed-button:hover.enabled {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(74, 155, 155, 0.4);
        }

        /* Responsive */
        @media (max-width: 1600px) {
            .main-layout {
                grid-template-columns: 1fr;
                gap: 2rem;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .header-left {
                flex-direction: column;
                gap: 1rem;
            }

            .header-training-progress {
                order: -1;
            }

            .header-progress-label {
                display: none;
            }

            .intro-section h2 {
                font-size: 2rem;
            }

            .negotiation-panel, .mentor-panel {
                padding: 1.5rem;
            }

            .input-controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="header-left">
                    <a href="index.html" class="logo">GrowToCourt</a>
                    <div class="step-indicator">
                        <span>Final Negotiation</span>
                    </div>
                    <!-- Header Training Progress -->
                    <div class="header-training-progress">
                        <div class="header-steps">
                            <div class="header-step completed" id="headerStep1">1</div>
                            <div class="header-step completed" id="headerStep2">2</div>
                            <div class="header-step completed" id="headerStep3">3</div>
                            <div class="header-step current" id="headerStep4">4</div>
                        </div>
                        <span class="header-progress-label">Training Progress</span>
                    </div>
                </div>
                <div class="nav-buttons">
                    <a href="client-consultation.html" class="nav-btn">‚Üê Previous Step</a>
                    <a href="index.html" class="nav-btn">Complete Training ‚Üí</a>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="main-content">
            <div class="intro-section">
                <h2>‚öñÔ∏è Final Negotiation Phase</h2>
                <p>Now negotiate directly with Sarah Chen from NeuroSys Technologies. Use your prepared requirements and mentor guidance to secure the best terms for QuantumLink AI.</p>
            </div>

            <div class="main-layout">
                <!-- Left Side - Negotiation Chat -->
                <div class="negotiation-panel">
                    <div class="negotiation-profile">
                        <div class="profile-header">
                            <div class="profile-avatar">SC</div>
                            <div class="profile-info">
                                <h3>Sarah Chen</h3>
                                <p>Senior Legal Counsel, NeuroSys Technologies Inc.</p>
                            </div>
                        </div>
                        
                        <div class="scenario-summary">
                            <h4>üìã Negotiation Context</h4>
                            <p>Technology Services Agreement between QuantumLink AI Ltd (UK) and NeuroSys Technologies Inc. (US) for cloud infrastructure supporting AI document automation platform.</p>
                        </div>

                        <div class="scenario-summary">
                            <h4>üéØ Your Client's Priorities</h4>
                            <p>IP protection, 99.9% SLA, UK/EU data residency, ¬£3M budget cap, liability limitations, and clear exit strategy.</p>
                        </div>
                    </div>

                    <div class="chat-container" id="chatContainer">
                        <!-- Messages will be added here dynamically -->
                    </div>

                    <div class="input-section">
                        <div class="input-controls">
                            <textarea id="messageInput" class="text-input" placeholder="Type your negotiation message..."></textarea>
                        </div>
                        <button id="sendBtn" class="send-btn">Send Message</button>
                    </div>
                </div>

                <!-- Right Side - Mentor AI -->
                <div class="mentor-panel">
                    <div class="section-header">
                        <div class="section-icon">
                            <svg fill="none" viewBox="0 0 24 24">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                            </svg>
                        </div>
                        <div>
                            <h3>Negotiation Mentor</h3>
                        </div>
                    </div>

                    <div class="mentor-chat" id="mentorChat">
                        <!-- Mentor messages will be added here -->
                    </div>

                    <div class="mentor-input-section">
                        <textarea id="mentorInput" class="mentor-input" placeholder="Ask for negotiation advice..."></textarea>
                        <button id="mentorBtn" class="mentor-btn">Get Mentor Advice</button>
                    </div>

                    <div class="progress-section">
                        <div class="progress-title">
                            üìä Negotiation Progress
                        </div>
                        
                        <div class="progress-stats">
                            <div class="stat-item">
                                <div class="stat-value" id="issuesResolved">0</div>
                                <div class="stat-label">Issues Resolved</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="totalIssues">6</div>
                                <div class="stat-label">Total Issues</div>
                            </div>
                        </div>

                        <div class="performance-meter">
                            <div class="meter-fill" id="progressFill"></div>
                        </div>
                    </div>

                    <button class="proceed-button" id="proceedBtn" onclick="completeNegotiation()">
                        Complete Negotiation
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Include JavaScript modules -->
    <script src="js/gcpConfig.js"></script>
    <script src="js/negotiationAgent.js"></script>
    <script src="js/mentorAgent.js"></script>
    <script>
        // Global variables
        let negotiationAgent = null;
        let mentorAgent = null;
        let resolvedIssues = new Set();
        let totalIssues = 6; // IP, SLA, Data Privacy, Commercial, Exit, Liability

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Load GCP configuration
                const gcpConfig = new GCPConfig();
                const config = gcpConfig.getConfig();
                
                // Check if configuration is valid
                if (!gcpConfig.isReady()) {
                    console.warn('‚ö†Ô∏è GCP not fully configured, using demo mode');
                    const status = gcpConfig.getConfigurationStatus();
                    console.log('Configuration status:', status);
                }
                
                // Initialize negotiation agent
                negotiationAgent = new NegotiationAgent(config.generativeAI.apiKey);
                console.log('‚öñÔ∏è Negotiation Agent initialized');

                // Initialize mentor agent
                mentorAgent = new MentorAgent(config.generativeAI.apiKey);
                console.log('üéì Mentor Agent initialized');

                // Load saved progress
                loadProgress();

                // Set up event listeners
                setupEventListeners();

                // Add initial greeting message
                setTimeout(() => {
                    addNegotiationMessage("Good morning! I'm Sarah Chen, Senior Legal Counsel at NeuroSys Technologies. I understand we're here to finalize the cloud services agreement for QuantumLink AI. I've reviewed your initial requirements and I'm ready to discuss the key terms. Shall we start with the intellectual property provisions?", 'counterparty');
                    addMentorMessage("Welcome to the negotiation phase! I'm here to provide strategic advice. Remember: stay focused on your client's priorities, be prepared to justify your positions, and look for win-win solutions. Feel free to ask me for advice on any negotiation point.", 'mentor');
                }, 1000);

            } catch (error) {
                console.error('‚ùå Failed to initialize application:', error);
                
                // Still try to initialize without API keys for demo purposes
                try {
                    negotiationAgent = new NegotiationAgent('');
                    mentorAgent = new MentorAgent('');
                    loadProgress();
                    setupEventListeners();
                    console.log('üîß Running in demo mode without API keys');
                    
                    // Add initial greeting message
                    setTimeout(() => {
                        addNegotiationMessage("Good morning! I'm Sarah Chen, Senior Legal Counsel at NeuroSys Technologies. I understand we're here to finalize the cloud services agreement for QuantumLink AI. I've reviewed your initial requirements and I'm ready to discuss the key terms. Shall we start with the intellectual property provisions?", 'counterparty');
                        addMentorMessage("Welcome to the negotiation phase! I'm here to provide strategic advice. Remember: stay focused on your client's priorities, be prepared to justify your positions, and look for win-win solutions. Feel free to ask me for advice on any negotiation point.", 'mentor');
                    }, 1000);
                } catch (demoError) {
                    console.error('‚ùå Failed to initialize even in demo mode:', demoError);
                }
            }
        });

        function setupEventListeners() {
            // Negotiation send button
            document.getElementById('sendBtn').addEventListener('click', sendNegotiationMessage);

            // Enter key in negotiation input
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendNegotiationMessage();
                }
            });

            // Mentor send button
            document.getElementById('mentorBtn').addEventListener('click', sendMentorMessage);

            // Enter key in mentor input
            document.getElementById('mentorInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMentorMessage();
                }
            });
        }

        async function sendNegotiationMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || !negotiationAgent) return;

            // Add user message to chat
            addNegotiationMessage(message, 'user');
            input.value = '';

            try {
                // Get negotiation response
                const response = await negotiationAgent.generateResponse(message);
                
                // Add counterparty response to chat
                addNegotiationMessage(response.message, 'counterparty');

                // Analyze for resolved issues
                analyzeNegotiationProgress(message, response.message);

            } catch (error) {
                console.error('Error getting negotiation response:', error);
                addNegotiationMessage('I apologize, but I need a moment to review our position. Could you please rephrase your last point?', 'counterparty');
            }
        }

        async function sendMentorMessage() {
            const input = document.getElementById('mentorInput');
            const message = input.value.trim();
            
            if (!message || !mentorAgent) return;

            // Add user question to mentor chat
            addMentorMessage(message, 'user');
            input.value = '';

            try {
                // Get mentor response
                const response = await mentorAgent.generateResponse(message);
                
                // Add mentor response to chat
                addMentorMessage(response.message, 'mentor');

            } catch (error) {
                console.error('Error getting mentor response:', error);
                addMentorMessage('I need a moment to consider that question. Could you try rephrasing it?', 'mentor');
            }
        }

        function addNegotiationMessage(message, sender) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            avatarDiv.textContent = sender === 'counterparty' ? 'SC' : 'You';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            const senderDiv = document.createElement('div');
            senderDiv.className = 'message-sender';
            senderDiv.textContent = sender === 'counterparty' ? 'Sarah Chen - NeuroSys Legal Counsel' : 'You - Clifford Chance Associate';

            const textDiv = document.createElement('div');
            textDiv.className = 'message-text';
            textDiv.textContent = message;

            contentDiv.appendChild(senderDiv);
            contentDiv.appendChild(textDiv);
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
            chatContainer.appendChild(messageDiv);

            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addMentorMessage(message, sender) {
            const mentorChat = document.getElementById('mentorChat');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            avatarDiv.textContent = sender === 'mentor' ? 'üéì' : 'üë§';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            const senderDiv = document.createElement('div');
            senderDiv.className = 'message-sender';
            senderDiv.textContent = sender === 'mentor' ? 'Negotiation Mentor' : 'You';

            const textDiv = document.createElement('div');
            textDiv.className = 'message-text';
            textDiv.textContent = message;

            contentDiv.appendChild(senderDiv);
            contentDiv.appendChild(textDiv);
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
            mentorChat.appendChild(messageDiv);

            // Scroll to bottom
            mentorChat.scrollTop = mentorChat.scrollHeight;
        }

        function analyzeNegotiationProgress(userMessage, counterpartyResponse) {
            const combinedText = (userMessage + ' ' + counterpartyResponse).toLowerCase();
            
            // Define keywords for each issue category
            const issueKeywords = {
                'ip': ['intellectual property', 'ip', 'proprietary', 'ownership', 'licensing', 'agreed', 'acceptable'],
                'sla': ['sla', 'service level', 'uptime', 'availability', 'performance', 'agreed', 'acceptable'],
                'privacy': ['data privacy', 'gdpr', 'processing', 'security', 'compliance', 'agreed', 'acceptable'],
                'commercial': ['budget', 'cost', 'payment', 'commercial', 'pricing', 'agreed', 'acceptable'],
                'exit': ['exit', 'termination', 'transition', 'migration', 'agreed', 'acceptable'],
                'liability': ['liability', 'indemnity', 'insurance', 'risk', 'agreed', 'acceptable']
            };

            // Check for resolution indicators
            const resolutionIndicators = ['agreed', 'acceptable', 'deal', 'settled', 'resolved', 'finalized'];
            const hasResolution = resolutionIndicators.some(indicator => combinedText.includes(indicator));

            if (hasResolution) {
                Object.keys(issueKeywords).forEach(issue => {
                    const keywords = issueKeywords[issue];
                    const hasIssueKeywords = keywords.some(keyword => combinedText.includes(keyword));
                    
                    if (hasIssueKeywords && !resolvedIssues.has(issue)) {
                        resolvedIssues.add(issue);
                        console.log(`‚úÖ Issue resolved: ${issue}`);
                    }
                });
            }

            updateProgress();
            saveProgress();
        }

        function updateProgress() {
            const resolvedCount = resolvedIssues.size;
            const percentage = (resolvedCount / totalIssues) * 100;

            // Update progress display
            document.getElementById('issuesResolved').textContent = resolvedCount;
            document.getElementById('progressFill').style.width = percentage + '%';

            // Enable proceed button when all issues are resolved
            const proceedBtn = document.getElementById('proceedBtn');
            if (resolvedCount >= totalIssues) {
                proceedBtn.classList.add('enabled');
                proceedBtn.textContent = 'All Issues Resolved - Complete Training ‚Üí';
                
                // Update header step progress
                const headerStep4 = document.getElementById('headerStep4');
                if (headerStep4) {
                    headerStep4.classList.remove('current');
                    headerStep4.classList.add('completed');
                }
            } else {
                proceedBtn.classList.remove('enabled');
                proceedBtn.textContent = 'Complete Negotiation';
            }
        }

        function saveProgress() {
            localStorage.setItem('negotiationProgress', JSON.stringify(Array.from(resolvedIssues)));
        }

        function loadProgress() {
            // Check if previous steps are completed
            const step1Complete = localStorage.getItem('step1Complete');
            const step2Complete = localStorage.getItem('step2Complete');
            const step3Complete = localStorage.getItem('step3Complete');
            
            if (step1Complete) {
                document.getElementById('headerStep1').classList.add('completed');
            }
            if (step2Complete) {
                document.getElementById('headerStep2').classList.add('completed');
            }
            if (step3Complete) {
                document.getElementById('headerStep3').classList.add('completed');
            }

            // Load negotiation progress
            const saved = localStorage.getItem('negotiationProgress');
            if (saved) {
                resolvedIssues = new Set(JSON.parse(saved));
                updateProgress();
            }
        }

        function completeNegotiation() {
            if (resolvedIssues.size >= totalIssues) {
                // Save completion status
                localStorage.setItem('stepCompleted_negotiation', 'true');
                localStorage.setItem('step4Complete', 'true');
                localStorage.setItem('trainingComplete', 'true');
                
                // Navigate to completion or home
                alert('Congratulations! You have successfully completed the GrowToCourt legal training program. You have demonstrated competency in client consultation, document review, and contract negotiation.');
                window.location.href = 'index.html';
            }
        }
    </script>
</body>
</html>
