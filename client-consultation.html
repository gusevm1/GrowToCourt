<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Consultation - GrowToCourt</title>
    <style>
        :root {
            --primary-black: #000000;
            --white: #ffffff;
            --clifford-teal: #4a9b9b;
            --light-grey: #f8f9fa;
            --medium-grey: #6c757d;
            --accent-grey: #495057;
            --success-green: #28a745;
            --warning-orange: #fd7e14;
            --danger-red: #dc3545;
            --info-blue: #17a2b8;
            --highlight-yellow: #fff3cd;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--primary-black);
            background-color: var(--white);
        }

        .container {
            max-width: 1700px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        header {
            background: var(--primary-black);
            color: var(--white);
            padding: 1.5rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 20px rgba(0,0,0,0.15);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 300;
            text-decoration: none;
            color: var(--white);
            letter-spacing: -0.5px;
        }

        .step-indicator {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1rem;
            opacity: 0.9;
        }

        /* Header Training Progress */
        .header-training-progress {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .header-steps {
            display: flex;
            gap: 0.5rem;
        }

        .header-step {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.6);
        }

        .header-step.current {
            border-color: var(--white);
            background: var(--white);
            color: var(--primary-black);
        }

        .header-step.completed {
            border-color: var(--clifford-teal);
            color: var(--clifford-teal);
        }

        .header-progress-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        .nav-buttons {
            display: flex;
            gap: 1rem;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.15);
            color: var(--white);
            padding: 0.6rem 1.2rem;
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-weight: 500;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }

        .nav-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Main Layout */
        .main-content {
            padding: 2rem 0;
            min-height: calc(100vh - 80px);
        }

        .intro-section {
            text-align: center;
            margin-bottom: 3rem;
        }

        .intro-section h2 {
            font-size: 2.5rem;
            font-weight: 300;
            color: var(--primary-black);
            margin-bottom: 1rem;
            letter-spacing: -1px;
        }

        .intro-section p {
            font-size: 1.2rem;
            color: var(--medium-grey);
            max-width: 900px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3rem;
            margin-top: 2rem;
        }

        /* Left Side - Client Conversation */
        .conversation-panel {
            background: var(--white);
            border-radius: 12px;
            padding: 2.5rem;
            box-shadow: 0 4px 30px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
            height: fit-content;
        }

        .client-profile {
            background: linear-gradient(135deg, #e8f4fd, #f0f8ff);
            border: 1px solid var(--clifford-teal);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .client-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .client-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--clifford-teal), var(--primary-black));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 1.5rem;
            font-weight: 600;
        }

        .client-details h3 {
            color: var(--primary-black);
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .client-details p {
            color: var(--medium-grey);
            font-size: 0.95rem;
        }

        .meeting-context {
            color: var(--accent-grey);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* Chat Interface */
        .chat-container {
            max-height: 500px;
            overflow-y: auto;
            border: 2px solid var(--light-grey);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background: var(--white);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .message {
            display: flex;
            gap: 0.8rem;
            margin-bottom: 1.5rem;
            align-items: flex-start;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 600;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .message.client .message-avatar {
            background: linear-gradient(135deg, var(--clifford-teal), var(--primary-black));
            color: var(--white);
        }

        .message.user .message-avatar {
            background: var(--primary-black);
            color: var(--white);
        }

        .message-content {
            background: var(--white);
            padding: 1.2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-width: 85%;
            line-height: 1.6;
        }

        .message.user .message-content {
            background: var(--light-grey);
            color: var(--primary-black);
        }

        .message-sender {
            font-size: 0.8rem;
            color: var(--medium-grey);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .message-text {
            font-size: 0.95rem;
        }

        /* Input Section */
        .input-section {
            background: var(--light-grey);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .input-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .text-input {
            flex: 1;
            min-height: 60px;
            padding: 0.8rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.9rem;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        .text-input:focus {
            outline: none;
            border-color: var(--primary-black);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }

        .send-btn {
            background: linear-gradient(135deg, var(--clifford-teal), var(--primary-black));
            color: var(--white);
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            margin-top: 1rem;
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(74, 155, 155, 0.4);
        }



        /* Right Side - Requirements Tracking */
        .requirements-panel {
            background: var(--white);
            border-radius: 12px;
            padding: 2.5rem;
            box-shadow: 0 4px 30px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
            height: fit-content;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .section-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary-black);
            color: var(--white);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .section-icon svg {
            width: 24px;
            height: 24px;
            stroke: var(--white);
            stroke-width: 2;
        }

        .section-header h3 {
            color: var(--primary-black);
            font-size: 1.4rem;
            font-weight: 600;
            margin: 0;
        }

        .requirements-list {
            list-style: none;
        }

        .requirement-category {
            margin-bottom: 2rem;
        }

        .category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--light-grey);
        }

        .category-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-black);
        }

        .category-status {
            background: var(--medium-grey);
            color: var(--white);
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .category-status.established {
            background: var(--clifford-teal);
        }

        .requirement-items {
            list-style: none;
        }

        .requirement-item {
            padding: 1rem;
            margin-bottom: 0.75rem;
            background: var(--light-grey);
            border-radius: 8px;
            border-left: 4px solid var(--medium-grey);
            font-size: 0.9rem;
            line-height: 1.5;
            transition: all 0.3s ease;
        }

        .requirement-item.established {
            border-left-color: var(--clifford-teal);
            background: linear-gradient(135deg, #f8ffff, var(--light-grey));
        }

        .progress-section {
            background: linear-gradient(135deg, #e8f4fd, #f0f8ff);
            border: 1px solid var(--clifford-teal);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .progress-title {
            color: var(--primary-black);
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .progress-bar {
            background: var(--light-grey);
            border-radius: 12px;
            height: 12px;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, var(--clifford-teal), var(--primary-black));
            height: 100%;
            border-radius: 12px;
            transition: width 0.5s ease;
            width: 0%;
        }

        .progress-text {
            font-size: 0.9rem;
            color: var(--medium-grey);
            text-align: center;
        }

        .proceed-button {
            background: linear-gradient(135deg, var(--clifford-teal), var(--primary-black));
            color: var(--white);
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            width: 100%;
            margin-top: 1.5rem;
            transition: all 0.3s ease;
            opacity: 0.5;
            cursor: not-allowed;
        }

        .proceed-button.enabled {
            opacity: 1;
            cursor: pointer;
        }

        .proceed-button:hover.enabled {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(74, 155, 155, 0.4);
        }

        /* Responsive */
        @media (max-width: 1600px) {
            .main-layout {
                grid-template-columns: 1fr;
                gap: 2rem;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .header-left {
                flex-direction: column;
                gap: 1rem;
            }

            .header-training-progress {
                order: -1;
            }

            .header-progress-label {
                display: none;
            }

            .intro-section h2 {
                font-size: 2rem;
            }

            .conversation-panel, .requirements-panel {
                padding: 1.5rem;
            }

            .input-controls {
                flex-direction: column;
            }

            .voice-controls {
                flex-direction: row;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="header-left">
                    <a href="index.html" class="logo">GrowToCourt</a>
                    <div class="step-indicator">
                        <span>Client Consultation</span>
                    </div>
                    <!-- Header Training Progress -->
                    <div class="header-training-progress">
                        <div class="header-steps">
                            <div class="header-step completed" id="headerStep1">1</div>
                            <div class="header-step completed" id="headerStep2">2</div>
                            <div class="header-step current" id="headerStep3">3</div>
                            <div class="header-step" id="headerStep4">4</div>
                        </div>
                        <span class="header-progress-label">Training Progress</span>
                    </div>
                </div>
                <div class="nav-buttons">
                    <a href="document-review.html" class="nav-btn">← Previous Step</a>
                    <a href="negotiations.html" class="nav-btn" id="nextBtn">Next Step →</a>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="main-content">
            <div class="intro-section">
                <h2>🤝 Client Consultation Session</h2>
                <p>Conduct a professional consultation with Marcus Thompson (CTO, GlobalBank International) to establish clear requirements for the cloud technology services agreement. Use speech or text to communicate.</p>
            </div>

            <div class="main-layout">
                <!-- Left Side - Client Conversation -->
                <div class="conversation-panel">
                    <div class="client-profile">
                        <div class="client-info">
                            <div class="client-avatar">RC</div>
                            <div class="client-details">
                                <h3>Dr. Rachel Chen</h3>
                                <p>Chief Technology Officer, QuantumLink AI Ltd</p>
                            </div>
                        </div>
                        <div class="meeting-context">
                            <strong>Meeting Purpose:</strong> Negotiate Technology Services Agreement with NeuroSys Technologies Inc. for cloud infrastructure to support AI document automation tools. Need to establish clear requirements across IP ownership, SLAs, data privacy, commercial terms, exit strategy, and liability provisions.
                        </div>
                    </div>

                    <div class="chat-container" id="chatContainer">
                        <div class="message client">
                            <div class="message-avatar">RC</div>
                            <div class="message-content">
                                <div class="message-sender">Dr. Rachel Chen - QuantumLink CTO</div>
                                <div class="message-text">
                                    Thanks for meeting with me today. We're negotiating a critical technology services agreement with NeuroSys Technologies for our AI document automation platform. As a UK-based AI startup, we need to get this contract structure right - our investors and board are counting on this partnership. I have specific questions across six key areas that I need your legal guidance on. Shall we start with intellectual property concerns?
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="input-section">
                        <div class="input-controls">
                            <textarea id="messageInput" class="text-input" placeholder="Ask about client requirements, priorities, or concerns..."></textarea>
                            <div class="input-controls">
                                <button id="sendBtn" class="send-btn">Send</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Side - Requirements Tracking -->
                <div class="requirements-panel">
                    <div class="section-header">
                        <div class="section-icon">
                            <svg fill="none" viewBox="0 0 24 24">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                        </div>
                        <div>
                            <h3>Requirements Established</h3>
                        </div>
                    </div>

                    <div class="requirements-list">
                        <!-- IP Ownership Category -->
                        <div class="requirement-category">
                            <div class="category-header">
                                <div class="category-title">🔐 Intellectual Property</div>
                                <div class="category-status" id="status-ip">0/5</div>
                            </div>
                            <ul class="requirement-items">
                                <li class="requirement-item" id="req-ip-0">
                                    Open-source/partner-licensed datasets ingestion on NeuroSys platform
                                </li>
                                <li class="requirement-item" id="req-ip-1">
                                    Co-development of existing IP (models, code, data) with NeuroSys engineers
                                </li>
                                <li class="requirement-item" id="req-ip-2">
                                    Downstream rights on AI outputs (sublicensing, resale reservations)
                                </li>
                                <li class="requirement-item" id="req-ip-3">
                                    Background IP ownership and licensing arrangements
                                </li>
                                <li class="requirement-item" id="req-ip-4">
                                    IP indemnification and warranty provisions
                                </li>
                            </ul>
                        </div>

                        <!-- Technical SLA Category -->
                        <div class="requirement-category">
                            <div class="category-header">
                                <div class="category-title">⚡ Technical SLAs</div>
                                <div class="category-status" id="status-sla">0/5</div>
                            </div>
                            <ul class="requirement-items">
                                <li class="requirement-item" id="req-sla-0">
                                    Minimum availability and performance requirements for end-users
                                </li>
                                <li class="requirement-item" id="req-sla-1">
                                    Issue acknowledgment vs full remediation timeframes
                                </li>
                                <li class="requirement-item" id="req-sla-2">
                                    Service credits/fee relief levels that make downtime "financially noticeable"
                                </li>
                                <li class="requirement-item" id="req-sla-3">
                                    Planned vs unplanned downtime distinctions
                                </li>
                                <li class="requirement-item" id="req-sla-4">
                                    Escalation procedures for service failures
                                </li>
                            </ul>
                        </div>

                        <!-- Data Privacy Category -->
                        <div class="requirement-category">
                            <div class="category-header">
                                <div class="category-title">🛡️ Data Privacy</div>
                                <div class="category-status" id="status-privacy">0/5</div>
                            </div>
                            <ul class="requirement-items">
                                <li class="requirement-item" id="req-privacy-0">
                                    Processing requirements in non-EU/UK regions for redundancy
                                </li>
                                <li class="requirement-item" id="req-privacy-1">
                                    Approved security certifications list (ISO 27001, SOC 2, etc.)
                                </li>
                                <li class="requirement-item" id="req-privacy-2">
                                    Audit rights frequency and scope (on-site vs remote)
                                </li>
                                <li class="requirement-item" id="req-privacy-3">
                                    GDPR compliance mechanisms and data processing agreements
                                </li>
                                <li class="requirement-item" id="req-privacy-4">
                                    Data breach notification and response procedures
                                </li>
                            </ul>
                        </div>

                        <!-- Commercial Risk Category -->
                        <div class="requirement-category">
                            <div class="category-header">
                                <div class="category-title">💰 Commercial Risk</div>
                                <div class="category-status" id="status-commercial">0/5</div>
                            </div>
                            <ul class="requirement-items">
                                <li class="requirement-item" id="req-commercial-0">
                                    Budget tolerance for annual or usage-based fee increases
                                </li>
                                <li class="requirement-item" id="req-commercial-1">
                                    Back-to-back terms matching downstream client contracts
                                </li>
                                <li class="requirement-item" id="req-commercial-2">
                                    Insurance levels currently carried vs NeuroSys requirements
                                </li>
                                <li class="requirement-item" id="req-commercial-3">
                                    Contract value and payment terms clarity
                                </li>
                                <li class="requirement-item" id="req-commercial-4">
                                    Risk allocation and cost control mechanisms
                                </li>
                            </ul>
                        </div>

                        <!-- Exit Strategy Category -->
                        <div class="requirement-category">
                            <div class="category-header">
                                <div class="category-title">🚪 Exit Strategy</div>
                                <div class="category-status" id="status-exit">0/5</div>
                            </div>
                            <ul class="requirement-items">
                                <li class="requirement-item" id="req-exit-0">
                                    Transition support window length for new provider onboarding
                                </li>
                                <li class="requirement-item" id="req-exit-1">
                                    NeuroSys technical migration assistance (model redeployment)
                                </li>
                                <li class="requirement-item" id="req-exit-2">
                                    Acceptable maximum fee for exit assistance services
                                </li>
                                <li class="requirement-item" id="req-exit-3">
                                    Data deletion and return procedures
                                </li>
                                <li class="requirement-item" id="req-exit-4">
                                    Business continuity during provider transition
                                </li>
                            </ul>
                        </div>

                        <!-- Liability Category -->
                        <div class="requirement-category">
                            <div class="category-header">
                                <div class="category-title">⚖️ Liability & Indemnity</div>
                                <div class="category-status" id="status-liability">0/5</div>
                            </div>
                            <ul class="requirement-items">
                                <li class="requirement-item" id="req-liability-0">
                                    Overall liability cap level reasonable for potential exposure
                                </li>
                                <li class="requirement-item" id="req-liability-1">
                                    Risks that must sit outside the cap (data-breach fines, IP claims)
                                </li>
                                <li class="requirement-item" id="req-liability-2">
                                    NeuroSys specific coverage requirements (cyber-liability insurance)
                                </li>
                                <li class="requirement-item" id="req-liability-3">
                                    Data breach indemnification and liability allocation
                                </li>
                                <li class="requirement-item" id="req-liability-4">
                                    IP infringement indemnification scope and coverage
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="progress-section">
                        <div class="progress-title">
                            📊 Consultation Progress
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="progress-text" id="progressText">0 of 30 requirements established</div>
                    </div>

                    <button class="proceed-button" id="proceedBtn" onclick="proceedToNegotiation()">
                        Complete Client Consultation
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Include JavaScript modules -->
    <script src="js/gcpConfig.js"></script>
    <script src="js/clientAgent.js"></script>
    <script>
        // Global variables
        let clientAgent = null;
        let speechAPI = null;
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let establishedRequirements = new Set();

                 // Template solution for automatic requirement tracking
         const templateSolution = {
             intellectual_property: [
                 "Open-source/partner-licensed datasets ingestion on NeuroSys platform",
                 "Co-development of existing IP (models, code, data) with NeuroSys engineers",
                 "Downstream rights on AI outputs (sublicensing, resale reservations)",
                 "Background IP ownership and licensing arrangements",
                 "IP indemnification and warranty provisions"
             ],
             technical_sla: [
                 "Minimum availability and performance requirements for end-users",
                 "Issue acknowledgment vs full remediation timeframes",
                 "Service credits/fee relief levels that make downtime 'financially noticeable'",
                 "Planned vs unplanned downtime distinctions",
                 "Escalation procedures for service failures"
             ],
             data_privacy: [
                 "Processing requirements in non-EU/UK regions for redundancy",
                 "Approved security certifications list (ISO 27001, SOC 2, etc.)",
                 "Audit rights frequency and scope (on-site vs remote)",
                 "GDPR compliance mechanisms and data processing agreements",
                 "Data breach notification and response procedures"
             ],
             commercial_risk: [
                 "Budget tolerance for annual or usage-based fee increases",
                 "Back-to-back terms matching downstream client contracts",
                 "Insurance levels currently carried vs NeuroSys requirements",
                 "Contract value and payment terms clarity",
                 "Risk allocation and cost control mechanisms"
             ],
             exit_termination: [
                 "Transition support window length for new provider onboarding",
                 "NeuroSys technical migration assistance (model redeployment)",
                 "Acceptable maximum fee for exit assistance services",
                 "Data deletion and return procedures",
                 "Business continuity during provider transition"
             ],
             liability_indemnity: [
                 "Overall liability cap level reasonable for potential exposure",
                 "Risks that must sit outside the cap (data-breach fines, IP claims)",
                 "NeuroSys specific coverage requirements (cyber-liability insurance)",
                 "Data breach indemnification and liability allocation",
                 "IP infringement indemnification scope and coverage"
             ]
         };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Load GCP configuration
                const gcpConfig = new GCPConfig();
                const config = gcpConfig.getConfig();
                
                // Check if configuration is valid
                if (!gcpConfig.isReady()) {
                    console.warn('⚠️ GCP not fully configured, using demo mode');
                    const status = gcpConfig.getConfigurationStatus();
                    console.log('Configuration status:', status);
                }
                
                // Initialize client agent
                clientAgent = new ClientAgent(config.generativeAI.apiKey);
                console.log('🏦 Client Agent initialized');

                // Load saved progress
                loadProgress();

                // Set up event listeners
                setupEventListeners();



                // Add initial greeting message
                setTimeout(() => {
                    addMessageToChat("Hi there! I'm Dr. Rachel Chen, CTO at QuantumLink AI. Thanks for taking the time to help us with this NeuroSys agreement. We're excited to get our AI platform properly set up with reliable cloud infrastructure. What would you like to know about our requirements?", 'client');
                }, 1000);

            } catch (error) {
                console.error('❌ Failed to initialize application:', error);
                
                // Still try to initialize without API keys for demo purposes
                try {
                    clientAgent = new ClientAgent('');
                    loadProgress();
                    setupEventListeners();
                    console.log('🔧 Running in demo mode without API keys');
                    
                    // Add initial greeting message
                    setTimeout(() => {
                        addMessageToChat("Hi there! I'm Dr. Rachel Chen, CTO at QuantumLink AI. Thanks for taking the time to help us with this NeuroSys agreement. We're excited to get our AI platform properly set up with reliable cloud infrastructure. What would you like to know about our requirements?", 'client');
                    }, 1000);
                } catch (demoError) {
                    console.error('❌ Failed to initialize even in demo mode:', demoError);
                }
            }
        });

        function setupEventListeners() {
            // Send button
            document.getElementById('sendBtn').addEventListener('click', sendMessage);

            // Enter key in text input
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || !clientAgent) return;

            // Add user message to chat
            addMessageToChat(message, 'user');
            input.value = '';

            try {
                // Get client response
                const response = await clientAgent.generateResponse(message);
                
                // Add client response to chat
                addMessageToChat(response.message, 'client');

                // Analyze conversation for requirement establishment
                analyzeConversationForRequirements(message, response.message);

            } catch (error) {
                console.error('Error getting client response:', error);
                addMessageToChat('I apologize, but I\'m having some technical difficulties. Could you please repeat your question?', 'client');
            }
        }



        function addMessageToChat(message, sender) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

                         const avatarDiv = document.createElement('div');
             avatarDiv.className = 'message-avatar';
             avatarDiv.textContent = sender === 'client' ? 'RC' : 'You';
 
             const contentDiv = document.createElement('div');
             contentDiv.className = 'message-content';
             
             const senderDiv = document.createElement('div');
             senderDiv.className = 'message-sender';
             senderDiv.textContent = sender === 'client' ? 'Dr. Rachel Chen - QuantumLink CTO' : 'You - Junior Associate';

            const textDiv = document.createElement('div');
            textDiv.className = 'message-text';
            textDiv.textContent = message;

            contentDiv.appendChild(senderDiv);
            contentDiv.appendChild(textDiv);
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
            chatContainer.appendChild(messageDiv);

            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function analyzeConversationForRequirements(userMessage, clientResponse) {
            // Simple keyword-based analysis to automatically mark requirements as established
            const combinedText = (userMessage + ' ' + clientResponse).toLowerCase();
            
                         // Define keywords for each category
             const keywords = {
                 'ip': ['intellectual property', 'ip', 'proprietary', 'ownership', 'licensing', 'open-source', 'datasets', 'co-development', 'sublicensing', 'resale', 'ai outputs'],
                 'sla': ['sla', 'service level', 'uptime', 'availability', 'performance', 'end-users', 'acknowledgment', 'remediation', 'credits', 'fee relief', 'downtime'],
                 'privacy': ['data privacy', 'gdpr', 'processing', 'non-eu', 'uk regions', 'redundancy', 'certifications', 'iso 27001', 'soc 2', 'audit rights', 'on-site', 'remote'],
                 'commercial': ['commercial', 'budget tolerance', 'fee increases', 'back-to-back', 'downstream', 'insurance', 'neurosys requirements', 'cost', 'pricing'],
                 'exit': ['exit', 'termination', 'transition support', 'migration assistance', 'redeployment', 'exit fee', 'data deletion', 'continuity'],
                 'liability': ['liability', 'indemnity', 'cap', 'carve-out', 'data-breach fines', 'ip claims', 'cyber-liability', 'coverage', 'infringement']
             };

            // Check each category for keyword matches
            Object.keys(keywords).forEach(category => {
                const categoryKeywords = keywords[category];
                const hasKeywords = categoryKeywords.some(keyword => combinedText.includes(keyword));
                
                if (hasKeywords) {
                    // Mark some requirements in this category as established
                    const categoryRequirements = getRequirementsByCategory(category);
                    const numToEstablish = Math.min(2, categoryRequirements.length); // Establish up to 2 per conversation
                    
                    for (let i = 0; i < numToEstablish; i++) {
                        const reqId = `req-${category}-${i}`;
                        if (!establishedRequirements.has(reqId)) {
                            establishedRequirements.add(reqId);
                            markRequirementEstablished(reqId);
                        }
                    }
                }
            });

            updateProgress();
            saveProgress();
        }

        function getRequirementsByCategory(category) {
            const categoryMap = {
                'ip': 'intellectual_property',
                'sla': 'technical_sla',
                'privacy': 'data_privacy',
                'commercial': 'commercial_risk',
                'exit': 'exit_termination',
                'liability': 'liability_indemnity'
            };
            
            return templateSolution[categoryMap[category]] || [];
        }

        function markRequirementEstablished(reqId) {
            const element = document.getElementById(reqId);
            if (element) {
                element.classList.add('established');
            }
        }

        function updateProgress() {
            const totalRequirements = 30;
            const establishedCount = establishedRequirements.size;
            const percentage = (establishedCount / totalRequirements) * 100;

            // Update overall progress
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = `${establishedCount} of ${totalRequirements} requirements established`;

            // Update category statuses
            const categories = ['ip', 'sla', 'privacy', 'commercial', 'exit', 'liability'];
            categories.forEach(category => {
                const categoryItems = Array.from(establishedRequirements).filter(item => item.includes(`req-${category}`));
                const statusElement = document.getElementById(`status-${category}`);
                if (statusElement) {
                    statusElement.textContent = `${categoryItems.length}/5`;
                    statusElement.classList.toggle('established', categoryItems.length === 5);
                }
            });

            // Enable proceed button when sufficient requirements are established (e.g., 80%)
            const proceedBtn = document.getElementById('proceedBtn');
            if (establishedCount >= 24) { // 80% of 30
                proceedBtn.classList.add('enabled');
                proceedBtn.textContent = 'Requirements Established - Proceed to Negotiation →';
                
                // Update header step progress
                const headerStep3 = document.getElementById('headerStep3');
                if (headerStep3) {
                    headerStep3.classList.remove('current');
                    headerStep3.classList.add('completed');
                }
            } else {
                proceedBtn.classList.remove('enabled');
                proceedBtn.textContent = 'Complete Client Consultation';
            }
        }

        function saveProgress() {
            localStorage.setItem('clientConsultationProgress', JSON.stringify(Array.from(establishedRequirements)));
        }

        function loadProgress() {
            // Check if previous steps are completed
            const step1Complete = localStorage.getItem('step1Complete');
            const step2Complete = localStorage.getItem('step2Complete');
            
            if (step1Complete) {
                document.getElementById('headerStep1').classList.add('completed');
            }
            if (step2Complete) {
                document.getElementById('headerStep2').classList.add('completed');
            }

            // Load consultation progress
            const saved = localStorage.getItem('clientConsultationProgress');
            if (saved) {
                establishedRequirements = new Set(JSON.parse(saved));
                
                // Update UI
                establishedRequirements.forEach(reqId => {
                    markRequirementEstablished(reqId);
                });
                
                updateProgress();
            }
        }

        function proceedToNegotiation() {
            if (establishedRequirements.size >= 24) {
                // Save completion status
                localStorage.setItem('stepCompleted_clientConsultation', 'true');
                localStorage.setItem('step3Complete', 'true');
                localStorage.setItem('clientRequirements', JSON.stringify(Array.from(establishedRequirements)));
                
                // Navigate to negotiation
                window.location.href = 'negotiations.html';
            }
        }
    </script>
</body>
</html> 